# Urban View Card Generator and RL Analysis MVP 

Cистема автоматизированного создания карточек визуального анализа городской среды с интеграцией GIS, обучения с подкреплением и генерацией отчетов.

Интерактивный виджет для QGIS, который обучает и оценивает табличных (tabular) RL‑агентов для задачи ранжирования изображений проектов. 

Включает читаемые таблицы, экспорт логов/оценок/траекторий, анимацию поведения и инструменты быстрого эксперимента (**train** → **eval** → **отчёт** и **бар‑чар**).

- Основной файл: RLAnalysisWidget (скопировать целиком в консоль QGIS и выполнить)

- БД: PostgreSQL/PostGIS, схема urbanview с таблицами проекта и изображений; для Q‑таблицы — urbanview.rl_q_table




**Демонстрация работы**

![Демонстрация](https://github.com/vbaryshev/urbanview/blob/35af937fa33504e8d43cf79639bd418579effecf/data/video/001.gif)


**Анализ**

![Демонстрация](https://github.com/vbaryshev/urbanview/blob/35af937fa33504e8d43cf79639bd418579effecf/data/video/002.gif)



**Интерфейс**

![image](https://github.com/vbaryshev/urbanview/blob/2a1adf633bca7db15db50f3ed64f4eb1048309dc/data/image/002.png)




## Ключевые функции MVP:
• Создание и редактирование карточек проектов с привязкой к координатам
• Загрузка и категоризация изображений с рекомендательной системой приоритетов
• Автоматическое заполнение ТЭП при пересечении с АГР землями
• Генерация PDF отчетов по шаблону
• Базовая система Q-learning для рекомендаций
• Экспорт датасета для тренировки диффузионной модели

## Технический стек MVP:
• QGIS + PyQGIS для GIS функциональности
• PostgreSQL/PostGIS для хранения данных
• Python 


## 2. User Stories

### Epic 1: Управление проектами

**US-101: Как пользователь, я хочу создавать новые проекты, чтобы сохранять анализ городской среды**
• Критерии приемки:
  – Можно ввести название проекта
  – Выбрать точку на карте для привязки
  – Сохранить проект в БД
  – Просмотреть список созданных проектов

**US-102: Как пользователь, я хочу редактировать существующие проекты, чтобы обновлять информацию**
• Критерии приемки:
  – Загрузка данных проекта по выбору из списка
  – Возможность изменения всех полей
  – Сохранение изменений

### Epic 2: Работа с изображениями

**US-201: Как пользователь, я хочу загружать изображения для проекта, чтобы визуализировать анализ**
• Критерии приемки:
  – Загрузка до 3 изображений с разными приоритетами
  – Автоматическое копирование и переименование файлов
  – Валидация форматов изображений

**US-202: Как пользователь, я хочу получать рекомендации по приоритету изображений, чтобы оптимизировать их организацию**
• Критерии приемки:
  – RL система предлагает приоритет на основе контекста
  – Сохранение фидбека для обучения модели

### Epic 3: Категоризация и теги

**US-301: Как пользователь, я хочу выбирать категории из выпадающих списков, чтобы стандартизировать классификацию**
• Критерии приемка:
  – Динамические списки из БД для ФНО, морфотипов и т.д.
  – Валидация обязательных полей

**US-302: Как пользователь, я хочу добавлять теги к проектам, чтобы улучшить поиск и фильтрацию**
• Критерии приемки:
  – Добавление новых тегов в систему
  – Отображение выбранных тегов

### Epic 4: Автоматизация данных

**US-401: Как пользователь, я хочу автоматическое заполнение ТЭП при выборе точки на карте, чтобы сэкономить время**
• Критерии приемки:
  – Автозаполнение при пересечении с агр землями
  – Ручное редактирование автозаполненных полей

### Epic 5: Генерация отчетов

**US-501: Как пользователь, я хочу экспортировать проект в PDF, чтобы делиться результатами анализа**
• Критерии приемки:
  – Генерация PDF по шаблону .qpt
  – Автоматическое заполнение всех полей шаблона
  – Сохранение в указанную директорию

### Epic 6: Машинное обучение

**US-601: Как Data Scientist, я хочу получать обновляемый датасет, чтобы тренировать диффузионные модели**
• Критерии приемки:
  – Автоматический экспорт метаданных в CSV
  – Структурированные данные о проектах и изображениях
  
### Быстрый старт

**1) Требования**
• QGIS 3.x с Python/Qt: PyQt5, Matplotlib Qt5Agg
• PostgreSQL 12+ (доступ к схеме urbanview)
• Пакеты Python: psycopg2, matplotlib (обязательно), imageio (опционально для GIF), numpy (только при GIF)

**2) Установите зависимости (внутри python‑окружения QGIS)**
# пример для системного интерпретатора, замените на путь до python QGIS
/path/to/qgis/python -m pip install psycopg2-binary matplotlib imageio numpy
# зафиксируйте версии
/path/to/qgis/python -m pip freeze > requirements.txt


**3) Настройте доступ к БД** 
В начале скрипта отредактируйте словарь PG:
PG = dict(host='localhost', port=5432, dbname='gis_database', user='geonode', password='A_888888')
SCHEMA = 'urbanview'

Таблица urbanview.rl_q_table создаётся автоматически при первом запуске виджета.

**4) Запуск**
Откройте QGIS → Панель Python → вставьте код виджета целиком → выполните.
Виджет UrbanView — RL Analysis откроется автоматически.

**5) Загрузка данных **
Нажмите Load dataset → Re-split train/test. По умолчанию берутся до k ≤ 3 изображений на проект (можно изменить MAX_IMAGES).
Убедитесь, что в БД есть:
  – urbanview.project_card (карточки проектов)
  – urbanview.project_image(project_id, path, priority) — порядок по priority считается эталоном (ground truth)
  – urbanview.project_teg(project_id, teg_id), urbanview.teg — теги (опционально, участвуют в хэше состояния)

### Корректность и воспроизводимость

Фиксация seed: поле Seed в секции Training setup. Меняет генератор random для:
  – сэмплирования действий при большом k
  – выбора эпизода/индекса в train/test
  – сплита train/test
  
Конфигурация сохраняется в QSettings (организация UrbanView, приложение RLAnalysis).
Экспорт/импорт Q‑таблиц:
  – В БД: кнопки Export Q to DB (agent) / Import Q from DB, таблица urbanview.rl_q_table
  – В JSON: Export Q (JSON) / Import Q (JSON)
  
Автосохранение: опция Autosave Q to DB every N episodes
Версионирование окружения:
  – Выполните pip freeze > requirements.txt в том же интерпретаторе, который использует QGIS (см. команду выше).
  – Для полной детерминизации (опционально): установите PYTHONHASHSEED=0 при запуске QGIS.



### Рабочий агент

Виджет включает 4 табличных агента (обновление по среде — одношаговое, целевое значение равняется полученной награде):

| Агент | Политика выбора действия | Основной гиперпараметр |
|---|---|---|
| Agent A (ε-const) | ε-greedy с постоянным ε | ε |
| Agent B (ε-decay) | линейный спад ε от ε_start к ε_end на decay шагах | ε_start, ε_end, decay |
| Agent C (softmax) | softmax по Q c температурой | τ |
| Agent D (UCB1) | Upper Confidence Bound | c |

• Показатель работоспособности: рост среднего reward по мере обучения на train (кривая скользящего среднего) и итоговые значения метрик на test выше случайной/наивной стратегии.
• Базовая наивная стратегия для сравнения: алфавитная сортировка (строка Canonical) и/или случайные перестановки при большом k.

Качество эксперимента

Гипотеза (по умолчанию в отчёте):
• Агент с убывающей ε (ε‑decay) обучается быстрее и достигает более высокого среднего вознаграждения по выбранной метрике, чем агент с постоянной ε, при равном числе эпизодов.

**Метрики награды/оценки:**
• Positional matches (доля совпадений по позициям)
• Top-1 (совпадение первого)
• Kendall tau (norm) (1 − нормированное число инверсий)
• Spearman footrule (norm) (1 − нормированная L1‑дистанция по позициям)

**Рекомендованные настройки для воспроизводимой проверки гипотезы:**
• Episodes (train): 1500
• Eval episodes (test): 300
• Reward metric: Positional matches (или переключите)
• Активируйте минимум 2 агента: Agent A (ε-const) и Agent B (ε-decay)
  – Пример: A: ε=0.6, B: ε_start=0.6, ε_end=0.05, decay=800
• Сэмплирование действий: если k > Enumerate perms if k ≤, используется случайная выборка перестановок (контролируется Seed)

### Шаги:
1) Load dataset → Re-split train/test
2) Настройте агентов и метрику
3) Train (enabled) → Evaluate (greedy)
или Run quick experiment (train+eval) на вкладке Experiment

### Количественные результаты:
• Таблица Evaluation (test split) покажет для каждого агента средние значения метрик по Eval episodes.
• Вкладка Experiment отрисует бар‑чарт по текущей метрике и сформирует текстовый отчёт (гипотеза, сводка, интерпретация).

### Пример ожидаемой картины (зависит от данных):
• ε-decay ≥ ε-const по Positional matches и Top-1, особенно при не слишком малом k
• softmax близок к ε-decay при корректном τ (слишком большой — «тёплая» политика дольше исследует, слишком маленький — преждевременная фиксация)
• UCB1 эффективен при полном перечислении действий (малые k); при жёстком сэмплинге действий выигрыш может снижаться

### Визуализация и логирование

• Кривые обучения: график Learning curves (скользящее среднее по reward, окно настраивается Smoothing window)
• Логи эпизодов: вкладка Episodes & Eval (сортируемая таблица, подсветка reward); экспорт Export Episodes CSV
• Оценка на test: таблица с 4 метриками; экспорт Export Eval CSV
• Поведение/анимация: вкладка Behavior → Predict (all) по выбранному Project
  – Ряд Canonical (alphabetical) — канонический порядок
  – Ряд Ground truth (DB) — порядок из БД (по priority)
  – Ряды агентов — предсказания с зелёной/красной рамкой совпадения/расхождения
  – Кнопки Play/Pause/Stop, скорость, скраббер шага, зацикливание
  – Экспорт траектории агента в CSV: Export trajectory (CSV)
  – Экспорт анимации: Export animation (PNG/GIF) (GIF при наличии imageio)

### Анализ и интерпретация результатов

• Почему ε‑decay обычно выигрывает: ранняя интенсивная разведка позволяет покрыть больше действий и быстрее получить сигналы награды; по мере убывания ε агент концентрируется на лучших действиях (эксплуатация).
• Роль размера пространства действий:
  – При малом k и полном перечислении перестановок UCB1/softmax быстрее выявляют доминирующее действие.
  – При большом k и случайном сэмплировании целесообразно вводить локальные операции (swap/insert/2‑opt) для сглаживания «ландшафта» и ускорения обучения.
• Метрика награды влияет на динамику: Top-1 может расти быстрее, чем Kendall/Spearman, так как требует менее жёсткого совпадения ранжирования.
• Возможные расхождения: шум в данных (ошибки priority), гетерогенность проектов (разный k, типологии), недостаточная разведка при слишком малом ε или слишком низкой температуре τ.

**  возможная оптимизация:**
• Пространство действий: добавить локальные ходы (swap/insert), гибрид «полные пермы при k≤K, локальные — иначе»
• Обучение: optimistic init, double Q, стратификация по k, ранняя остановка
• Валидация: кросс‑валидация, стратифицированный сплит по морфологиям/типологиям, контроль утечек
• Отчётность: сводные боксплоты/виолин‑плоты метрик, разбиение результатов по k

### Качество отчёта и чистота кода

• Код сгруппирован по секциям: БД, состояние/хэш, метрики, пространство действий, кэш миниатюр, агенты, виджет, обучение/оценка/экспорт.
– RLAnalysisWidget — основной UI и логика
  – TabularAgent — табличный агент с политиками eps_const, eps_decay, softmax, ucb1
  – enumerate_actions — перечисление/сэмплирование перестановок
  – Метрики: positional_matches_reward, top1_reward, kendall_tau_reward, spearman_footrule_reward
• Комментарии добавлены к ключевым шагам; имена переменных самодокументируемые; параметры вынесены в верхние константы и UI.
• Экспорт всех артефактов (логи, оценки, Q‑таблицы, траектории, анимации) доступен из UI для аудита и репликации.

### Структура данных и ожидания

• Пути изображений в urbanview.project_image.path должны быть валидными и доступными для чтения QGIS.
• Эталонный порядок — сортировка по priority (DB). Канонический порядок для отображения — алфавит по имени файла.
• Состояние (для хэша) формируется из полей проекта (id_fno_group, id_view_object, id_morphotype, id_typology, vri_id) и отсортированного набора teg_id. Изменение состава полей изменит хэш и, соответственно, строки в rl_q_table.

### Воспроизводимость: чек‑лист

• [ ] Зафиксирован Seed в UI
• [ ] pip freeze > requirements.txt сохранён вместе с артефактами
• [ ] Экспортированы Q‑таблицы (Export Q (JSON) и/или в БД)
• [ ] Экспортированы логи эпизодов и табличка оценок (CSV)
• [ ] Для поведенческого анализа сохранены траектории (CSV) и/или GIF/PNG‑кадры

### Примечание

• Нет подключения к БД: проверьте PG и сетевой доступ; убедитесь, что таблицы схемы urbanview существуют.
• Пустой датасет: заполните urbanview.project_image (минимум 1 запись на проект), проверьте MAX_IMAGES.
• GIF не экспортируется: установите imageio и numpy в окружение QGIS.
• Нулевой прогресс reward: увеличьте Episodes, ослабьте ε‑жадность (выше ε/τ/c), убедитесь, что действия действительно различаются (при большом k — поднимите Actions samples).

Если нужен готовый readme.md файл или пресеты гиперпараметров/экспериментов, скажите — сгенерирую и приложу к проекту.
• Ключевые классы и функции:
